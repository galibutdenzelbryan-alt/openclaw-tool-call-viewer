<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{AGENT_NAME}} Tool Call Viewer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>{{AGENT_ICON}}</text></svg>">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      margin: 0;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    h1 {
      color: #58a6ff;
      margin: 0;
    }
    .export-btn {
      background: #238636;
      border: 1px solid #2ea043;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .export-btn:hover { background: #2ea043; }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .controls label {
      color: #8b949e;
      font-size: 0.9em;
    }
    select, input {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #58a6ff;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px 20px;
      min-width: 120px;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #58a6ff;
    }
    .stat-card .label {
      font-size: 12px;
      color: #8b949e;
      text-transform: uppercase;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #161b22;
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }
    col.col-tool { width: 120px; }
    col.col-args { width: 50%; }
    col.col-time { width: 120px; }
    col.col-model { width: 130px; }
    col.col-session { width: 130px; }
    col.col-copy { width: 55px; }
    th {
      background: #21262d;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      color: #8b949e;
      cursor: pointer;
      user-select: none;
      position: sticky;
      top: 0;
    }
    th:hover { background: #30363d; }
    th.sorted { color: #58a6ff; }
    .sort-arrow {
      display: inline-block;
      width: 14px;
      text-align: center;
      margin-left: 4px;
      visibility: hidden;
    }
    .sort-arrow.visible { visibility: visible; }
    th:hover .sort-arrow { visibility: visible; opacity: 0.5; }
    th:hover .sort-arrow.visible { opacity: 1; }
    td {
      padding: 10px 15px;
      border-top: 1px solid #21262d;
      vertical-align: top;
    }
    tr:hover { background: #1c2128; }
    tr { cursor: pointer; }
    .copy-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #238636;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    .copy-toast.show { opacity: 1; }
    .copy-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #8b949e;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }
    .copy-btn:hover { background: #30363d; color: #c9d1d9; }
    .tool-name {
      font-family: 'SF Mono', Monaco, monospace;
      background: #21262d;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 13px;
      color: #f0883e;
      word-break: break-all;
      display: inline-block;
    }
    .timestamp {
      color: #8b949e;
      font-size: 12px;
    }
    .session-id {
      font-family: monospace;
      font-size: 11px;
      color: #6e7681;
    }
    .arguments {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      max-height: 100px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      background: #0d1117;
      padding: 8px;
      border-radius: 4px;
      width: 100%;
      cursor: pointer;
    }
    .arguments:hover { border: 1px solid #30363d; }
    .model {
      font-size: 11px;
      color: #7ee787;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    .pagination {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
      align-items: center;
    }
    .pagination button {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .pagination button:hover { background: #30363d; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-info { color: #8b949e; }
    .type-dropdown {
      position: relative;
      display: inline-block;
    }
    .type-dropdown-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      min-width: 180px;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .type-dropdown-btn:hover { border-color: #58a6ff; }
    .type-dropdown-btn::after { content: 'â–¼'; font-size: 10px; margin-left: 10px; }
    .type-dropdown-content {
      display: none;
      position: absolute;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      min-width: 220px;
      max-height: 350px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .type-dropdown-content.show { display: block; }
    .type-dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .type-dropdown-item:hover { background: #21262d; }
    .type-dropdown-item input[type="checkbox"] {
      accent-color: #58a6ff;
      width: 16px;
      height: 16px;
    }
    .type-dropdown-item .name { flex: 1; }
    .type-dropdown-item .count {
      background: #30363d;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      color: #8b949e;
    }
    .type-dropdown-actions {
      padding: 8px 12px;
      border-top: 1px solid #30363d;
      display: flex;
      gap: 8px;
    }
    .type-dropdown-actions button {
      background: #21262d;
      border: 1px solid #30363d;
      color: #8b949e;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .type-dropdown-actions button:hover { background: #30363d; color: #c9d1d9; }
    .sort-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .sort-order-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      line-height: 1;
    }
    .sort-order-btn:hover { border-color: #58a6ff; }
    .search-card {
      display: flex;
      align-items: center;
      padding: 10px 15px;
    }
    .search-card input {
      background: #0d1117;
      border: 1px solid #30363d;
      width: 200px;
    }
    .clear-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #8b949e;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .clear-btn:hover { background: #30363d; color: #f85149; }
    .auto-refresh {
      margin-left: auto;
    }
    .refresh-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #8b949e;
      font-size: 0.9em;
    }
    .refresh-toggle input {
      accent-color: #58a6ff;
      width: 16px;
      height: 16px;
    }
    .refresh-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #30363d;
      transition: background 0.3s;
    }
    .refresh-indicator.active {
      background: #3fb950;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .header h1 { font-size: 1.3em; }
      .stats { flex-direction: column; gap: 10px; }
      .stat-card { min-width: auto; width: 100%; }
      .search-card { flex-direction: row; }
      .search-card input { flex: 1; width: auto; }
      .controls { flex-direction: column; align-items: stretch; gap: 10px; }
      .controls > div { width: 100%; }
      .controls select, .controls input[type="date"] { width: 100%; }
      .type-dropdown { width: 100%; }
      .type-dropdown-btn { width: 100%; }
      .sort-group { flex-wrap: wrap; }
      .sort-group select { flex: 1; }
      table { font-size: 12px; }
      th, td { padding: 8px 6px; }
      .arguments { max-width: 200px; max-height: 60px; font-size: 10px; }
      .tool-name { font-size: 11px; padding: 2px 5px; }
      .session-id { font-size: 9px; }
      .pagination { flex-wrap: wrap; }
      .page-info { width: 100%; text-align: center; order: -1; margin-bottom: 10px; }
      .auto-refresh { margin-left: 0; margin-top: 10px; }
    }
    
    @media (max-width: 480px) {
      .header h1 { font-size: 1.1em; }
      th:nth-child(4), td:nth-child(4) { display: none; } /* Hide Model column */
      th:nth-child(5), td:nth-child(5) { display: none; } /* Hide Session column */
      .arguments { max-width: 120px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>{{AGENT_NAME}} Tool Call Viewer</h1>
    <button class="export-btn" onclick="exportData()">ðŸ“¥ Export</button>
  </div>

  <div class="stats" id="stats">
    <div class="stat-card">
      <div class="value" id="total-calls">-</div>
      <div class="label">Total Calls</div>
    </div>
    <div class="stat-card">
      <div class="value" id="unique-types">-</div>
      <div class="label">Tool Types</div>
    </div>
    <div class="stat-card">
      <div class="value" id="sessions-count">-</div>
      <div class="label">Sessions</div>
    </div>
    <div class="stat-card search-card">
      <input type="text" id="search" placeholder="Search tools or args...">
    </div>
    <button class="clear-btn" onclick="clearFilters()" title="Clear all filters">âœ• Clear</button>
  </div>

  <div class="controls">
    <div class="type-dropdown" id="type-dropdown">
      <button class="type-dropdown-btn" onclick="toggleTypeDropdown()">
        <span id="type-dropdown-label">All Tools</span>
      </button>
      <div class="type-dropdown-content" id="type-dropdown-content">
        <div class="type-dropdown-actions">
          <button onclick="selectAllTypes()">All</button>
          <button onclick="selectNoTypes()">None</button>
        </div>
        <div id="type-dropdown-items"></div>
      </div>
    </div>
    <div>
      <label>Session:</label>
      <select id="session-filter">
        <option value="">All Sessions</option>
      </select>
    </div>
    <div>
      <label>From:</label>
      <input type="date" id="date-from">
    </div>
    <div>
      <label>To:</label>
      <input type="date" id="date-to">
    </div>
    <div>
      <label>Per page:</label>
      <select id="per-page">
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="250">250</option>
        <option value="500">500</option>
      </select>
    </div>
    <div class="auto-refresh">
      <label class="refresh-toggle">
        <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()" checked>
        <span class="refresh-label">Auto-refresh</span>
        <span class="refresh-indicator" id="refresh-indicator"></span>
      </label>
    </div>
  </div>

  <input type="hidden" id="sort-field-hidden" value="timestamp">

  <div id="content">
    <div class="loading">Loading tool calls...</div>
  </div>

  <div class="pagination" id="pagination"></div>
  <div class="copy-toast" id="copy-toast">Copied to clipboard!</div>

  <script>
    let allCalls = [];
    let filteredCalls = [];
    let currentPage = 1;
    let selectedTypes = new Set();
    let allTypesSelected = true;
    let sortOrder = 'desc';
    let stats = {};
    let sessions = [];
    let autoRefreshInterval = null;

    async function loadData() {
      try {
        const res = await fetch('/api/tools');
        allCalls = await res.json();
        
        // Calculate stats
        stats = {};
        const sessionSet = new Set();
        for (const call of allCalls) {
          stats[call.name] = (stats[call.name] || 0) + 1;
          sessionSet.add(call.sessionId);
        }
        sessions = Array.from(sessionSet).sort();
        
        document.getElementById('total-calls').textContent = allCalls.length.toLocaleString();
        document.getElementById('unique-types').textContent = Object.keys(stats).length;
        document.getElementById('sessions-count').textContent = sessions.length;
        
        // Populate session dropdown
        const sessionSelect = document.getElementById('session-filter');
        sessions.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s.slice(0, 8) + '...';
          sessionSelect.appendChild(opt);
        });
        
        // Set default date range (last 7 days)
        const today = new Date();
        const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('date-to').value = today.toISOString().split('T')[0];
        document.getElementById('date-from').value = weekAgo.toISOString().split('T')[0];
        
        renderTypeFilters();
        applyFilters();
      } catch (e) {
        document.getElementById('content').innerHTML = '<div class="loading">Error loading data: ' + e.message + '</div>';
      }
    }

    function renderTypeFilters() {
      const container = document.getElementById('type-dropdown-items');
      const sorted = Object.entries(stats).sort((a, b) => b[1] - a[1]);
      
      // If initial load (allTypesSelected true and empty), select all
      if (allTypesSelected && selectedTypes.size === 0) {
        sorted.forEach(([name]) => selectedTypes.add(name));
      }
      
      container.innerHTML = '';
      for (const [name, count] of sorted) {
        const checked = selectedTypes.has(name) ? 'checked' : '';
        container.innerHTML += `
          <label class="type-dropdown-item">
            <input type="checkbox" value="${name}" ${checked} onchange="toggleType('${name}')">
            <span class="name">${name}</span>
            <span class="count">${count}</span>
          </label>
        `;
      }
      
      updateTypeLabel();
    }
    
    function toggleTypeDropdown() {
      document.getElementById('type-dropdown-content').classList.toggle('show');
    }
    
    function toggleType(name) {
      if (selectedTypes.has(name)) {
        selectedTypes.delete(name);
      } else {
        selectedTypes.add(name);
      }
      allTypesSelected = selectedTypes.size === Object.keys(stats).length;
      currentPage = 1;
      updateTypeLabel();
      applyFilters();
    }
    
    function selectAllTypes() {
      Object.keys(stats).forEach(name => selectedTypes.add(name));
      allTypesSelected = true;
      currentPage = 1;
      renderTypeFilters();
      applyFilters();
    }
    
    function selectNoTypes() {
      selectedTypes.clear();
      allTypesSelected = false;
      currentPage = 1;
      renderTypeFilters();
      applyFilters();
    }
    
    function toggleSortOrder() {
      sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
      document.getElementById('sort-order-btn').textContent = sortOrder === 'desc' ? 'â†“' : 'â†‘';
      applyFilters();
    }
    
    function updateTypeLabel() {
      const total = Object.keys(stats).length;
      const label = document.getElementById('type-dropdown-label');
      if (selectedTypes.size === 0) {
        label.textContent = 'No Tools Selected';
      } else if (selectedTypes.size === total) {
        label.textContent = 'All Tools';
      } else if (selectedTypes.size <= 2) {
        label.textContent = Array.from(selectedTypes).join(', ');
      } else {
        label.textContent = `${selectedTypes.size} tools selected`;
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.type-dropdown')) {
        document.getElementById('type-dropdown-content').classList.remove('show');
      }
    });

    function sortBy(field) {
      const current = document.getElementById('sort-field-hidden').value;
      if (current === field) {
        sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
      } else {
        document.getElementById('sort-field-hidden').value = field;
        sortOrder = 'desc';
      }
      applyFilters();
    }

    function applyFilters() {
      const search = document.getElementById('search').value.toLowerCase();
      const sortField = document.getElementById('sort-field-hidden').value;
      const sessionFilter = document.getElementById('session-filter').value;
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;
      
      filteredCalls = allCalls.filter(call => {
        // If none selected explicitly, show nothing
        if (!allTypesSelected && selectedTypes.size === 0) return false;
        // If some selected, filter by them
        if (selectedTypes.size > 0 && !selectedTypes.has(call.name)) return false;
        if (sessionFilter && call.sessionId !== sessionFilter) return false;
        
        // Date filtering
        if (dateFrom || dateTo) {
          const callDate = new Date(call.timestamp);
          if (dateFrom && callDate < new Date(dateFrom)) return false;
          if (dateTo && callDate > new Date(dateTo + 'T23:59:59')) return false;
        }
        
        if (search) {
          const argsStr = JSON.stringify(call.arguments || {}).toLowerCase();
          return call.name.toLowerCase().includes(search) || argsStr.includes(search);
        }
        return true;
      });
      
      filteredCalls.sort((a, b) => {
        let cmp = 0;
        if (sortField === 'timestamp') {
          cmp = new Date(a.timestamp) - new Date(b.timestamp);
        } else if (sortField === 'name') {
          cmp = a.name.localeCompare(b.name);
        } else if (sortField === 'sessionId') {
          cmp = (a.sessionId || '').localeCompare(b.sessionId || '');
        } else if (sortField === 'model') {
          cmp = (a.model || '').localeCompare(b.model || '');
        }
        return sortOrder === 'asc' ? cmp : -cmp;
      });
      
      render();
    }

    function render() {
      const perPage = parseInt(document.getElementById('per-page').value);
      const totalPages = Math.ceil(filteredCalls.length / perPage);
      const start = (currentPage - 1) * perPage;
      const pageCalls = filteredCalls.slice(start, start + perPage);
      
      const sf = document.getElementById('sort-field-hidden').value;
      const a = sortOrder === 'desc' ? 'â†“' : 'â†‘';
      const arr = (field) => `<span class="sort-arrow ${sf === field ? 'visible' : ''}">${sf === field ? a : 'â†“'}</span>`;
      
      let html = `
        <table>
          <colgroup>
            <col class="col-tool">
            <col class="col-args">
            <col class="col-time">
            <col class="col-model">
            <col class="col-session">
            <col class="col-copy">
          </colgroup>
          <thead>
            <tr>
              <th onclick="sortBy('name')" class="${sf === 'name' ? 'sorted' : ''}">Tool${arr('name')}</th>
              <th>Arguments</th>
              <th onclick="sortBy('timestamp')" class="${sf === 'timestamp' ? 'sorted' : ''}">Time${arr('timestamp')}</th>
              <th onclick="sortBy('model')" class="${sf === 'model' ? 'sorted' : ''}">Model${arr('model')}</th>
              <th onclick="sortBy('sessionId')" class="${sf === 'sessionId' ? 'sorted' : ''}">Session${arr('sessionId')}</th>
              <th>Copy</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (let i = 0; i < pageCalls.length; i++) {
        const call = pageCalls[i];
        const fullTime = new Date(call.timestamp).toLocaleString().replace(/"/g, '&quot;');
        const timeStr = relativeTime(call.timestamp);
        const args = call.arguments ? JSON.stringify(call.arguments, null, 2) : '-';
        const rowIndex = start + i;
        
        html += `
          <tr ondblclick="copyRow(${rowIndex})" title="Double-click to copy row">
            <td><span class="tool-name">${call.name}</span></td>
            <td><div class="arguments" ondblclick="copyText(filteredCalls[${rowIndex}].arguments ? JSON.stringify(filteredCalls[${rowIndex}].arguments, null, 2) : '-'); event.stopPropagation();">${escapeHtml(args)}</div></td>
            <td class="timestamp" title="${fullTime}">${timeStr}</td>
            <td class="model">${call.model || '-'}</td>
            <td class="session-id">${call.sessionId || '-'}</td>
            <td><button class="copy-btn" onclick="copyRow(${rowIndex}); event.stopPropagation();">ðŸ“‹</button></td>
          </tr>
        `;
      }
      
      html += '</tbody></table>';
      document.getElementById('content').innerHTML = html;
      
      // Pagination
      document.getElementById('pagination').innerHTML = `
        <button ${currentPage === 1 ? 'disabled' : ''} onclick="goPage(1)">Â«</button>
        <button ${currentPage === 1 ? 'disabled' : ''} onclick="goPage(${currentPage - 1})">â€¹</button>
        <span class="page-info">Page ${currentPage} of ${totalPages} (${filteredCalls.length.toLocaleString()} results)</span>
        <button ${currentPage === totalPages ? 'disabled' : ''} onclick="goPage(${currentPage + 1})">â€º</button>
        <button ${currentPage === totalPages ? 'disabled' : ''} onclick="goPage(${totalPages})">Â»</button>
      `;
    }

    function goPage(page) {
      currentPage = page;
      render();
      window.scrollTo(0, 0);
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function copyRow(index) {
      const call = filteredCalls[index];
      const data = {
        tool: call.name,
        arguments: call.arguments,
        timestamp: call.timestamp,
        model: call.model,
        sessionId: call.sessionId
      };
      const text = JSON.stringify(data, null, 2);
      copyText(text);
    }

    function copyText(text) {
      // Try modern API first
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
          .then(() => showToast('Copied to clipboard!'))
          .catch(() => fallbackCopy(text));
        return;
      }
      fallbackCopy(text);
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.cssText = 'position:fixed;left:-9999px;top:-9999px;opacity:0';
      document.body.appendChild(ta);
      
      // iOS needs special handling
      const range = document.createRange();
      range.selectNodeContents(ta);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      ta.setSelectionRange(0, text.length);
      
      try {
        document.execCommand('copy');
        showToast('Copied to clipboard!');
      } catch (e) {
        showToast('Copy failed â€” try manually');
      }
      document.body.removeChild(ta);
    }

    function showToast(msg) {
      const toast = document.getElementById('copy-toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function exportData() {
      const data = JSON.stringify(filteredCalls, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tool-calls-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast(`Exported ${filteredCalls.length} calls`);
    }

    function clearFilters() {
      document.getElementById('search').value = '';
      document.getElementById('session-filter').value = '';
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';
      selectedTypes = new Set(Object.keys(stats));
      allTypesSelected = true;
      currentPage = 1;
      renderTypeFilters();
      applyFilters();
      showToast('Filters cleared');
    }

    function relativeTime(timestamp) {
      const now = Date.now();
      const then = new Date(timestamp).getTime();
      const diff = now - then;
      
      const mins = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return new Date(timestamp).toLocaleDateString();
    }

    function toggleAutoRefresh() {
      const enabled = document.getElementById('auto-refresh-toggle').checked;
      const indicator = document.getElementById('refresh-indicator');
      
      if (enabled) {
        indicator.classList.add('active');
        autoRefreshInterval = setInterval(refreshData, 10000); // 10 seconds
        showToast('Auto-refresh enabled (10s)');
      } else {
        indicator.classList.remove('active');
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        showToast('Auto-refresh disabled');
      }
    }

    async function refreshData() {
      try {
        const res = await fetch('/api/tools');
        const newCalls = await res.json();
        
        // Check if there are new calls
        const newCount = newCalls.length - allCalls.length;
        
        allCalls = newCalls;
        
        // Recalculate stats
        stats = {};
        const sessionSet = new Set();
        for (const call of allCalls) {
          stats[call.name] = (stats[call.name] || 0) + 1;
          sessionSet.add(call.sessionId);
        }
        sessions = Array.from(sessionSet).sort();
        
        document.getElementById('total-calls').textContent = allCalls.length.toLocaleString();
        document.getElementById('unique-types').textContent = Object.keys(stats).length;
        document.getElementById('sessions-count').textContent = sessions.length;
        
        applyFilters();
        
        if (newCount > 0) {
          showToast(`+${newCount} new tool call${newCount > 1 ? 's' : ''}`);
        }
      } catch (e) {
        console.error('Refresh failed:', e);
      }
    }

    // Event listeners
    document.getElementById('search').addEventListener('input', () => { currentPage = 1; applyFilters(); });
    document.getElementById('session-filter').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('date-from').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('date-to').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('per-page').addEventListener('change', () => { currentPage = 1; render(); });

    // Load data on start
    loadData();
    
    // Enable auto-refresh by default
    document.getElementById('refresh-indicator').classList.add('active');
    autoRefreshInterval = setInterval(refreshData, 10000);
  </script>
</body>
</html>
